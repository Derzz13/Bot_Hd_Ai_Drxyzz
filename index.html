<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Penjernih Foto & Video</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass: rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,Arial; background:linear-gradient(180deg,#071024 0%, #07182a 60%); color:#e6eef6; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px}
    .wrap{width:100%; max-width:980px}
    header{display:flex; gap:16px; align-items:center; margin-bottom:18px}
    header h1{font-size:20px; margin:0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:18px}
    .uploader{display:flex; flex-direction:column; gap:12px}
    .drop{border:2px dashed rgba(255,255,255,0.06); border-radius:10px; padding:18px; text-align:center; background:var(--glass); cursor:pointer}
    input[type=file]{display:none}
    .controls{display:flex; gap:10px; align-items:center}
    button{background:var(--accent); color:#042027; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:700}
    button.secondary{background:transparent; color:var(--accent); border:1px solid rgba(6,182,212,0.12)}
    .preview{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border-radius:10px; padding:12px; min-height:320px; display:flex; align-items:center; justify-content:center; position:relative}
    .meta{margin-top:10px; color:var(--muted); font-size:13px}
    .progress{height:8px; width:100%; background:rgba(255,255,255,0.04); border-radius:999px; overflow:hidden}
    .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent), #60a5fa); transition:width 220ms linear}
    canvas, img, video{max-width:100%; max-height:100%; border-radius:6px}
    footer{margin-top:14px; color:var(--muted); font-size:13px}
    .note{margin-top:8px; font-size:13px}
    .fake-badge{position:absolute; left:12px; top:12px; background:rgba(2,6,23,0.6); padding:6px 8px; border-radius:8px; font-weight:700; font-size:12px}
    @media (max-width:880px){.grid{grid-template-columns:1fr;}.uploader{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:46px;height:46px;background:linear-gradient(135deg,var(--accent),#7c3aed);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700">PJ</div>
      <div>
        <h1>Penjernih Foto — Replicate (Real-ESRGAN)</h1>
        <div class="meta">Frontend ini akan mengirim file ke backend lokal <code>/api/enhance</code> yang meneruskan ke Replicate. Isi API token di server (.env).</div>
      </div>
    </header>

    <div class="card grid">
      <div class="uploader">
        <label class="drop" id="dropZone">
          <div style="font-weight:700">Klik atau tarik file di sini</div>
          <div class="meta">PNG / JPG / WEBP — maksimal 1440p rekomendasi</div>
          <input id="fileInput" type="file" accept="image/*" />
        </label>

        <div class="controls">
          <button id="enhanceBtn" disabled>Enhance to HD</button>
          <button class="secondary" id="downloadBtn" disabled>Download hasil</button>
          <button class="secondary" id="resetBtn">Reset</button>
        </div>

        <div class="note">Catatan: server akan memanggil model Real-ESRGAN di Replicate. Jangan letakkan token di file ini — masukkan di .env pada server.</div>

        <div style="margin-top:12px">
          <div class="progress" aria-hidden>
            <i id="progressBar"></i>
          </div>
          <div class="meta" id="statusText"></div>
        </div>
      </div>

      <div>
        <div class="preview" id="previewArea">
          <div class="fake-badge">Demo</div>
          <div id="placeholder">
            <div style="text-align:center">
              <div style="font-weight:700; font-size:16px; margin-bottom:6px">Preview</div>
              <div class="meta">Belum ada file diunggah</div>
            </div>
          </div>
        </div>

        <div class="meta" id="fileInfo"></div>
      </div>
    </div>

    <footer class="card" style="margin-top:14px">
      <strong>Catatan teknis</strong>
      <p class="meta">Server di-backend menggunakan paket <code>replicate</code> dan membaca token dari <code>.env</code>. Hasil yang dikembalikan diteruskan ke klien sebagai file.</p>
    </footer>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const previewArea = document.getElementById('previewArea');
    const enhanceBtn = document.getElementById('enhanceBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    const fileInfo = document.getElementById('fileInfo');

    let currentFile = null;
    let resultBlob = null;

    ['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.style.borderColor = 'rgba(6,182,212,0.9)'; }));
    ['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.style.borderColor = ''; }));

    dropZone.addEventListener('click', ()=> fileInput.click());
    dropZone.addEventListener('drop', e => {
      const f = e.dataTransfer.files[0];
      if(f) handleFile(f);
    });

    fileInput.addEventListener('change', e => {
      const f = e.target.files[0];
      if(f) handleFile(f);
    });

    resetBtn.addEventListener('click', resetAll);

    downloadBtn.addEventListener('click', ()=>{
      if(!resultBlob) return;
      const url = URL.createObjectURL(resultBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = currentFile ? ('enhanced-' + currentFile.name) : 'enhanced-output';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    enhanceBtn.addEventListener('click', async ()=>{
      if(!currentFile) return;
      statusText.textContent = 'Mengunggah ke server...';
      progress(10);
      const fd = new FormData();
      fd.append('file', currentFile);
      try{
        const resp = await fetch('/api/enhance', { method:'POST', body: fd });
        if(!resp.ok) {
          const txt = await resp.text();
          throw new Error(txt || 'Server error');
        }
        progress(60);
        statusText.textContent = 'Menunggu hasil dari model...';
        const blob = await resp.blob();
        resultBlob = blob;
        showBlobImage(blob);
        downloadBtn.disabled = false;
        progress(100);
        statusText.textContent = 'Selesai — unduh hasil.';
      }catch(err){
        console.error(err);
        statusText.textContent = 'Gagal: ' + err.message;
        progress(0);
      }
    });

    function handleFile(file){
      currentFile = file;
      resultBlob = null;
      downloadBtn.disabled = true;
      enhanceBtn.disabled = false;
      fileInfo.textContent = `${file.name} • ${(file.size/1024/1024).toFixed(2)} MB • ${file.type}`;
      statusText.textContent = '';
      clearPreview();

      if(file.type.startsWith('image/')){
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.onload = ()=> URL.revokeObjectURL(img.src);
        appendToPreview(img);
      } else {
        alert('Hanya gambar didukung oleh demo ini. Untuk video gunakan model video khusus.');
      }
    }

    function clearPreview(){
      Array.from(previewArea.children).forEach(child=>{
        if(!child.classList.contains('fake-badge')) child.remove();
      });
    }

    function appendToPreview(el){
      clearPreview();
      el.style.maxWidth = '100%';
      el.style.maxHeight = '100%';
      previewArea.appendChild(el);
    }

    function resetAll(){
      currentFile = null; resultBlob = null; fileInfo.textContent=''; statusText.textContent=''; progress(0);
      enhanceBtn.disabled = true; downloadBtn.disabled = true; clearPreview();
      document.getElementById('placeholder') && previewArea.appendChild(document.getElementById('placeholder'));
    }

    function progress(p){ progressBar.style.width = p + '%'; }
    function showBlobImage(blob){
      const url = URL.createObjectURL(blob);
      clearPreview();
      const img = document.createElement('img'); img.src = url; img.onload = ()=> URL.revokeObjectURL(url);
      previewArea.appendChild(img);
    }
  </script>
</body>
</html>
